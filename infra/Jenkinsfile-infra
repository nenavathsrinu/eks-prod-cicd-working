pipeline {
  agent any

  environment {
    AWS_REGION = "ap-south-2"
  }

  stages {

    stage('Checkout Infra Code') {
      steps {
        git branch: 'main',
            url: 'https://github.com/nenavathsrinu/eks-prod-cicd-working.git'
      }
    }

    stage('Terraform Init') {
      steps {
        withCredentials([
          [
            $class: 'AmazonWebServicesCredentialsBinding',
            credentialsId: 'aws-cred'
          ]
        ]) {
          bat '''
          cd infra
          terraform init -input=false
          '''
        }
      }
    }

    stage('Terraform Plan') {
      steps {
        withCredentials([
          [
            $class: 'AmazonWebServicesCredentialsBinding',
            credentialsId: 'aws-cred'
          ]
        ]) {
          bat '''
          cd infra
          terraform plan -out=tfplan
          '''
        }
      }
    }

    stage('Terraform Apply (Approval)') {
      steps {
        input message: 'Approve Terraform Apply?'
        withCredentials([
          [
            $class: 'AmazonWebServicesCredentialsBinding',
            credentialsId: 'aws-cred'
          ]
        ]) {
          bat '''
          cd infra
          terraform apply tfplan
          '''
        }
      }
    }
  }
}
