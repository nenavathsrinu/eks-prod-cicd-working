pipeline {
  agent any

  parameters {
    choice(
      name: 'ACTION',
      choices: ['APPLY', 'DESTROY'],
      description: 'Choose APPLY to create/update infra or DESTROY to delete infra'
    )
  }

  stages {

    stage('Checkout Infra Code') {
      steps {
        git branch: 'main',
            url: 'https://github.com/nenavathsrinu/eks-prod-cicd-working.git'
      }
    }

    stage('Terraform Init') {
      steps {
        withCredentials([
          [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-cred']
        ]) {
          bat '''
          cd infra
          terraform init -input=false
          '''
        }
      }
    }

    stage('Terraform Plan') {
      when {
        expression { params.ACTION == 'APPLY' }
      }
      steps {
        withCredentials([
          [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-cred']
        ]) {
          bat '''
          cd infra
          terraform plan
          '''
        }
      }
    }

    stage('Terraform Apply (Approval)') {
      when {
        expression { params.ACTION == 'APPLY' }
      }
      steps {
        input message: 'Approve Terraform APPLY?'
        withCredentials([
          [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-cred']
        ]) {
          bat '''
          cd infra
          terraform apply -auto-approve
          '''
        }
      }
    }

    stage('Terraform Destroy (Safety Check)') {
      when {
        expression { params.ACTION == 'DESTROY' }
      }
      steps {
        input message: '⚠️ WARNING: This will DESTROY all infrastructure. Continue?'
        withCredentials([
          [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-cred']
        ]) {
          bat '''
          cd infra
          terraform destroy -auto-approve
          '''
        }
      }
    }
  }
}
